<%
var layout = '../layouts/layout.ejs';
function fmt(n) {
    var s = String(n || 0);
    var parts = [];
    var len = s.length;
    for (var i = len; i > 0; i -= 3) {
        var start = Math.max(0, i - 3);
        parts.unshift(s.substring(start, i));
    }
    return parts.join(' ');
}

var userName = (user.firstName || '') + ' ' + (user.lastName || '');
var userUsername = user.username ? '@' + user.username : '-';
var userPhone = user.phone || 'Kiritilmagan';
var userCreatedAt = moment(user.createdAt).utcOffset(5).format('DD/MM/YYYY HH:mm');
var hasDebt = (stats.totalDebt || 0) > 0;
var hasOrders = user.orders && user.orders.length > 0;
var hasPayments = payments && payments.length > 0;
var hasProducts = productsStats && productsStats.products && productsStats.products.length > 0;
var profitValue = hasProducts ? (productsStats.totalSellValue - productsStats.totalCostValue) : 0;

var ordersRowsHTML = '';
if (hasOrders) {
    for (var i = 0; i < user.orders.length; i++) {
        var order = user.orders[i];
        var sc = 'secondary'; var st = order.status || '';
        if (order.status === 'pending') { sc = 'warning'; st = 'Kutilmoqda'; }
        else if (order.status === 'confirmed') { sc = 'info'; st = 'Tasdiqlangan'; }
        else if (order.status === 'delivered') { sc = 'success'; st = 'Yetkazilgan'; }
        else if (order.status === 'cancelled') { sc = 'danger'; st = 'Bekor qilingan'; }
        var dc = order.debt > 0 ? 'text-danger fw-bold' : 'text-success';
        ordersRowsHTML += '<tr><td class="ps-3"><a href="/admin/orders/' + order._id + '">#' + order.orderNumber + '</a></td>' +
            '<td>' + fmt(order.totalSum) + '</td><td>' + fmt(order.paidSum) + '</td>' +
            '<td class="' + dc + '">' + fmt(order.debt) + '</td>' +
            '<td><span class="badge bg-' + sc + '">' + st + '</span></td>' +
            '<td>' + moment(order.createdAt).utcOffset(5).format('DD/MM/YYYY') + '</td></tr>';
    }
} else {
    ordersRowsHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Buyurtmalar yoq</td></tr>';
}

var paymentsRowsHTML = '';
if (hasPayments) {
    for (var pi = 0; pi < payments.length; pi++) {
        var pay = payments[pi];
        var sellerName = pay.seller ? ((pay.seller.firstName || '') + ' ' + (pay.seller.lastName || '')) : (pay.adminName || 'System');
        paymentsRowsHTML += '<tr><td class="ps-3">' + moment(pay.createdAt).utcOffset(5).format('DD/MM/YYYY HH:mm') + '</td>' +
            '<td class="text-success fw-bold">' + fmt(pay.amount) + '</td><td>' + sellerName + '</td>' +
            '<td>' + (pay.notes || '-') + '</td>' +
            '<td class="text-end pe-3"><form action="/admin/users/' + user._id + '/payments/' + pay._id + '/delete" method="POST" style="display:inline">' +
            '<button type="submit" class="btn btn-sm btn-outline-danger border-0" onclick="return confirm(this.dataset.msg)" data-msg="Ochirasizmi?"><i class="fas fa-trash"></i></button></form></td></tr>';
    }
} else {
    paymentsRowsHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Tolovlar tarixi bosh</td></tr>';
}

var productsRowsHTML = '';
if (hasProducts) {
    for (var pp = 0; pp < productsStats.products.length; pp++) {
        var p = productsStats.products[pp];
        var skc = p.stock <= 5 ? 'text-danger' : p.stock <= 10 ? 'text-warning' : 'text-success';
        productsRowsHTML += '<tr><td>' + p.name + '</td>' +
            '<td><span class="badge bg-secondary opacity-75">' + p.category + '</span></td>' +
            '<td class="' + skc + ' fw-bold">' + p.stock + '</td>' +
            '<td>' + fmt(p.costPrice) + '</td><td>' + fmt(p.sellPrice) + '</td>' +
            '<td class="text-info fw-bold">' + fmt(p.profit) + '</td></tr>';
    }
}

var orderOptionsHTML = '';
if (hasOrders) {
    for (var oi = 0; oi < user.orders.length; oi++) {
        var o = user.orders[oi];
        if (o.debt > 0) {
            orderOptionsHTML += '<option value="' + o._id + '">#' + o.orderNumber + ' - Qarz: ' + fmt(o.debt) + '</option>';
        }
    }
}

// Build the page body
var body = '<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">' +
    '<h1 class="h2"><i class="fas fa-user me-2"></i>' + userName + '</h1>' +
    '<div class="btn-toolbar mb-2 mb-md-0 d-flex gap-1">' +
    (hasProducts ? '<a href="/admin/users/' + user._id + '/export-products" class="btn btn-sm btn-outline-success shadow-sm"><i class="fas fa-file-excel me-1"></i>Mahsulotlar</a>' : '') +
    (hasOrders ? '<a href="/admin/users/' + user._id + '/export-orders" class="btn btn-sm btn-outline-primary shadow-sm"><i class="fas fa-file-excel me-1"></i>Buyurtmalar</a>' : '') +
    (hasDebt ? '<a href="/admin/users/' + user._id + '/export" class="btn btn-sm btn-success shadow-sm"><i class="fas fa-file-excel me-1"></i>Qarzdorlik Excel</a>' : '') +
    '<a href="/admin/users" class="btn btn-sm btn-outline-secondary shadow-sm ms-2"><i class="fas fa-arrow-left me-2"></i>Orqaga</a></div></div>' +

    '<div class="row"><div class="col-lg-4">' +

    '<div class="card mb-3 shadow-sm border-0">' +
    '<div class="card-header bg-white border-bottom-0 pb-0"><h5 class="mb-0 fw-bold">Foydalanuvchi</h5></div>' +
    '<div class="card-body">' +
    '<div class="mb-2"><strong>Ism:</strong> ' + userName + '</div>' +
    '<div class="mb-2"><strong>Username:</strong> <span class="text-primary">' + userUsername + '</span></div>' +
    '<div class="mb-2"><strong>Telegram ID:</strong> <code>' + (user.telegramId || '-') + '</code></div>' +
    '<div class="mb-2"><strong>Telefon:</strong> ' + userPhone + '</div>' +
    '<div class="mb-2"><strong>Qayd:</strong> ' + userCreatedAt + '</div><hr>' +
    '<div class="mb-2"><strong>Buyurtmalar:</strong> ' + (user.orderCount || 0) + ' ta</div>' +
    '<div class="mb-2"><strong>Umumiy summa:</strong> ' + fmt(user.totalSpent) + '</div>' +
    '<div class="mb-2"><strong>Tulandi:</strong> <span class="text-success">' + fmt(stats.totalPaid) + '</span></div>' +
    '<div class="mb-2"><strong>Qarzdorlik:</strong> <span class="' + (hasDebt ? 'text-danger fw-bold' : 'text-success') + '">' + fmt(stats.totalDebt) + '</span></div><hr>' +
    '<div class="mb-2"><strong>Status:</strong> <span class="badge bg-' + (user.isActive ? 'success' : 'danger') + '">' + (user.isActive ? 'Aktiv' : 'Nofaol') + '</span></div>' +
    '<div class="mb-2"><strong>Sotib olish:</strong> <span class="badge bg-' + (!user.isBlocked ? 'success' : 'warning') + '">' + (!user.isBlocked ? 'Ruxsat berilgan' : 'Bloklangan') + '</span></div>' +
    '<div class="mb-2"><strong>Rol:</strong> <span class="badge bg-' + (user.role === 'admin' ? 'danger' : user.role === 'seller' ? 'warning' : 'info') + '">' + (user.role === 'admin' ? 'Admin' : user.role === 'seller' ? 'Sotuvchi' : 'Klient') + '</span></div>' +
    '</div></div>' +

    '<div class="card mb-3 shadow-sm border-0">' +
    '<div class="card-header bg-white border-bottom-0 pb-0"><h5 class="mb-0 fw-bold text-center">Boshqaruv</h5></div>' +
    '<div class="card-body">' +
    '<form method="POST" action="/admin/users/' + user._id + '/toggle-block" class="mb-2">' +
    '<button type="submit" class="btn btn-' + (user.isBlocked ? 'success' : 'outline-warning') + ' btn-sm w-100 py-2">' +
    '<i class="fas fa-' + (user.isBlocked ? 'check-circle' : 'lock') + ' me-2"></i>' +
    (user.isBlocked ? 'Sotib olishga ruxsat berish' : 'Sotib olishni cheklash') + '</button></form>' +
    '<form method="POST" action="/admin/users/' + user._id + '/toggle-status" class="mb-2">' +
    '<button type="submit" class="btn btn-' + (user.isActive ? 'outline-danger' : 'success') + ' btn-sm w-100 py-2">' +
    '<i class="fas fa-' + (user.isActive ? 'user-slash' : 'user-check') + ' me-2"></i>' +
    (user.isActive ? 'Profilni nofaol qilish' : 'Profilni faollashtirish') + '</button></form>' +
    '<button type="button" class="btn btn-primary btn-sm w-100 py-2 shadow-sm mb-2" data-bs-toggle="modal" data-bs-target="#paymentModal" ' + ((!hasDebt && !hasOrders) ? 'disabled' : '') + '>' +
    '<i class="fas fa-plus-circle me-2"></i>Tolov qoshish</button>' +
    (user.role !== 'admin' ? '<form method="POST" action="/admin/users/' + user._id + '/delete" onsubmit="return confirm(this.dataset.msg)" data-msg="Bu foydalanuvchini butunlay ochirasizmi?">' +
    '<button type="submit" class="btn btn-danger btn-sm w-100 py-2"><i class="fas fa-trash-alt me-2"></i>Foydalanuvchini ochirish</button></form>' : '') +
    '</div></div>' +

    '<div class="card mb-3 shadow-sm border-0">' +
    '<div class="card-header bg-white border-bottom-0 pb-0"><h5 class="mb-0 fw-bold">Eslatmalar</h5></div>' +
    '<div class="card-body">' +
    '<form method="POST" action="/admin/users/' + user._id + '/notes">' +
    '<div class="mb-2"><textarea class="form-control" name="notes" rows="3" placeholder="Izoh...">' + (user.notes || '') + '</textarea></div>' +
    '<button type="submit" class="btn btn-outline-primary btn-sm w-100 shadow-sm">Saqlash</button>' +
    '</form></div></div></div>' +

    '<div class="col-lg-8">' +

    '<div class="card mb-4 shadow-sm border-0">' +
    '<div class="card-header bg-white border-bottom-0"><h5 class="mb-0 fw-bold text-success"><i class="fas fa-history me-2"></i>Tolovlar tarixi</h5></div>' +
    '<div class="card-body p-0"><div class="table-responsive">' +
    '<table class="table table-hover align-middle mb-0"><thead class="table-light"><tr>' +
    '<th class="ps-3">Sana</th><th>Summa</th><th>Masul</th><th>Izoh</th><th class="text-end pe-3">Amallar</th>' +
    '</tr></thead><tbody>' + paymentsRowsHTML + '</tbody></table></div></div></div>' +

    '<div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center"><h5 class="mb-0 fw-bold text-primary"><i class="fas fa-shopping-bag me-2"></i>Buyurtmalar tarixi</h5>' +
    (hasOrders ? '<a href="/admin/users/' + user._id + '/export-orders" class="text-primary text-decoration-none small"><i class="fas fa-file-excel me-1"></i>Excel</a>' : '') + '</div>' +
    '<div class="card-body p-0"><div class="table-responsive">' +
    '<table class="table table-hover align-middle mb-0"><thead class="table-light"><tr>' +
    '<th class="ps-3">No</th><th>Summa</th><th>Tulangan</th><th>Qarz</th><th>Holat</th><th>Sana</th>' +
    '</tr></thead><tbody>' + ordersRowsHTML + '</tbody></table></div></div></div>';

if (hasProducts) {
    body += '<div class="card mb-4 shadow-sm border-0">' +
        '<div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">' +
        '<h5 class="mb-0 fw-bold text-info"><i class="fas fa-boxes me-2"></i>Mahsulotlar hisoboti</h5>' +
        '<a href="/admin/users/' + user._id + '/export-products" class="text-info text-decoration-none small mx-3"><i class="fas fa-file-excel me-1"></i>Excel</a>' +
        '<span class="badge bg-light text-info border">' + productsStats.totalProducts + ' mahsulot</span></div>' +
        '<div class="card-body">' +
        '<div class="row g-2 mb-3">' +
        '<div class="col-md-3"><div class="p-3 bg-light rounded text-center"><div class="small text-muted">Jami dona</div><div class="h5 mb-0 fw-bold">' + fmt(productsStats.totalStock) + '</div></div></div>' +
        '<div class="col-md-3"><div class="p-3 bg-light rounded text-center"><div class="small text-muted">Tannarxi</div><div class="h5 mb-0 fw-bold text-danger">' + fmt(productsStats.totalCostValue) + '</div></div></div>' +
        '<div class="col-md-3"><div class="p-3 bg-light rounded text-center"><div class="small text-muted">Sotish</div><div class="h5 mb-0 fw-bold text-success">' + fmt(productsStats.totalSellValue) + '</div></div></div>' +
        '<div class="col-md-3"><div class="p-3 bg-light rounded text-center"><div class="small text-muted">Foyda</div><div class="h5 mb-0 fw-bold text-info">' + fmt(profitValue) + '</div></div></div></div>' +
        '<div class="table-responsive" style="max-height:400px;border-radius:10px">' +
        '<table class="table table-sm table-hover align-middle mb-0"><thead class="table-light sticky-top"><tr>' +
        '<th>Nomi</th><th>Kategoriya</th><th>Soni</th><th>Tannarx</th><th>Sotish</th><th>Poyda</th>' +
        '</tr></thead><tbody>' + productsRowsHTML + '</tbody>' +
        '<tfoot class="table-light fw-bold"><tr><td colspan="2">JAMI:</td><td>' + fmt(productsStats.totalStock) + '</td><td colspan="2">-</td><td class="text-info">' + fmt(profitValue) + '</td></tr></tfoot>' +
        '</table></div></div></div>';
}

body += '</div></div>' +
    '<div class="modal fade" id="paymentModal" tabindex="-1">' +
    '<div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow">' +
    '<div class="modal-header bg-primary text-white border-bottom-0 rounded-top">' +
    '<h5 class="modal-title fw-bold">Tolov qoshish</h5>' +
    '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>' +
    '<form method="POST" action="/admin/users/' + user._id + '/payment">' +
    '<div class="modal-body p-4">' +
    '<div class="mb-3"><label class="form-label fw-bold small">Amal turi</label>' +
    '<div class="d-flex gap-2">' +
    '<input type="radio" class="btn-check" name="type" id="typePay" value="subtract" checked>' +
    '<label class="btn btn-outline-success w-50" for="typePay"><i class="fas fa-hand-holding-usd me-1"></i>To\'lov</label>' +
    '<input type="radio" class="btn-check" name="type" id="typeDebt" value="add">' +
    '<label class="btn btn-outline-danger w-50" for="typeDebt"><i class="fas fa-file-invoice-dollar me-1"></i>Xarajat</label>' +
    '</div></div>' +
    '<div class="mb-3"><label class="form-label fw-bold small">Summa (so\'m)</label>' +
    '<input type="number" class="form-control form-control-lg bg-light border-0 shadow-sm" name="amount" required min="100" step="100" placeholder="0"></div>' +
    '<div class="mb-3"><label class="form-label fw-bold small text-muted">Izoh (ixtiyoriy)</label>' +
    '<input type="text" class="form-control bg-light border-0 shadow-sm" name="notes" placeholder="To\'lov/Xarajat haqida malumot"></div>' +
    (hasOrders ? '<div class="mb-3"><label class="form-label fw-bold small text-muted">Aynan bir buyurtma uchun (ixtiyoriy)</label>' +
    '<select class="form-select bg-light border-0 shadow-sm" name="orderId"><option value="">Avtomatik (Eski qarzlardan)</option>' + orderOptionsHTML + '</select></div>' : '') +
    '</div><div class="modal-footer border-top-0 px-4 pb-4">' +
    '<button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Bekor qilish</button>' +
    '<button type="submit" class="btn btn-primary px-4 shadow">Saqlash</button>' +
    '</div></form></div></div></div>';
-%>
<%- include(layout, { body: body, title: title }) %>