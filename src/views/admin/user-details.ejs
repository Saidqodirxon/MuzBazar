<%
const layout = '../layouts/layout.ejs';

// Prepare variables
const userName = (user.firstName || '') + ' ' + (user.lastName || '');
const userUsername = user.username ? '@' + user.username : "Yo'q";
const userPhone = user.phone || 'Kiritilmagan';
const userCreatedAt = moment(user.createdAt).format('DD/MM/YYYY HH:mm');
const userOrderCount = user.orderCount || 0;
const userTotalSpent = (user.totalSpent || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
const userStatusBadge = user.isActive ? 'success' : 'danger';
const userStatusText = user.isActive ? 'Aktiv' : 'Nofaol';
const userRoleBadge = user.role === 'admin' ? 'danger' : user.role === 'seller' ? 'warning' : 'info';
const userRoleText = user.role === 'admin' ? 'Admin' : user.role === 'seller' ? 'Sotuvchi' : 'Klient';
const toggleBtnClass = user.isActive ? 'warning' : 'success';
const toggleIcon = user.isActive ? 'ban' : 'check';
const toggleText = user.isActive ? 'Bloklash' : 'Aktivlashtirish';
const roleClientSelected = user.role === 'client' ? 'selected' : '';
const roleSellerSelected = user.role === 'seller' ? 'selected' : '';
const roleAdminSelected = user.role === 'admin' ? 'selected' : '';
const exportOrdersDisabled = !user.orders || user.orders.length === 0 ? 'disabled' : '';
const exportDebtDisabled = stats.totalDebt === 0 ? 'disabled' : '';
const notifyDisabled = user.telegramId ? '' : 'disabled';

// Build orders table
let ordersTableHtml = '<p class="text-muted">Buyurtmalar yoq</p>';
if (user.orders && user.orders.length > 0) {
    let rows = '';
    for (const order of user.orders) {
        let statusClass = 'secondary';
        let statusText = order.status;
        switch (order.status) {
            case 'pending': statusClass = 'warning'; statusText = 'Kutilmoqda'; break;
            case 'confirmed': statusClass = 'info'; statusText = 'Tasdiqlangan'; break;
            case 'delivered': statusClass = 'success'; statusText = 'Yetkazilgan'; break;
            case 'cancelled': statusClass = 'danger'; statusText = 'Bekor qilingan'; break;
        }
        const orderSum = (order.totalSum || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        const orderPaid = (order.paidSum || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        const orderDebt = (order.debt || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        const orderDate = moment(order.createdAt).format('DD/MM/YYYY');
        rows += '<tr><td><a href="/admin/orders/' + order._id + '">#' + order.orderNumber + '</a></td>';
        rows += '<td>' + orderSum + " so'm</td>";
        rows += '<td>' + orderPaid + " so'm</td>";
        rows += '<td class="' + (order.debt > 0 ? 'text-danger fw-bold' : 'text-success') + '">' + orderDebt + " so'm</td>";
        rows += '<td><span class="badge bg-' + statusClass + '">' + statusText + '</span></td>';
        rows += '<td>' + orderDate + '</td></tr>';
    }
    ordersTableHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Buyurtma â„–</th><th>Jami summa</th><th>To\'landi</th><th>Qarz</th><th>Status</th><th>Sana</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
}
-%>
<%- include(layout, { body: `
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user me-2"></i>${userName}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <!-- <a href="/admin/users/${user._id}/export-orders" class="btn btn-primary me-2" ${exportOrdersDisabled}>
            <i class="fas fa-file-excel me-2"></i>Buyurtmalar Excel
        </a>
        <a href="/admin/users/${user._id}/export" class="btn btn-success me-2" ${exportDebtDisabled}>
            <i class="fas fa-file-excel me-2"></i>Qarzdorlik Excel
        </a> -->
        <a href="/admin/users" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Orqaga
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5>Foydalanuvchi malumotlari</h5>
            </div>
            <div class="card-body">
                <p><strong>Ism:</strong> ${userName}</p>
                <p><strong>Username:</strong> ${userUsername}</p>
                <p><strong>Telegram ID:</strong> ${user.telegramId}</p>
                <p><strong>Telefon:</strong> ${userPhone}</p>
                <p><strong>Qayd qilingan:</strong> ${userCreatedAt}</p>
                <p><strong>Buyurtmalar soni:</strong> ${userOrderCount}</p>
                <p><strong>Umumiy summa:</strong> ${userTotalSpent} so'm</p>
                <p><strong>To'landi:</strong> ${(stats.totalPaid || 0).toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ')} so'm</p>
                <p><strong>Qarzdorlik:</strong> ${(stats.totalDebt || 0).toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ')} so'm</p>
                <p><strong>Status:</strong> 
                    <span class="badge bg-${userStatusBadge}">
                        ${userStatusText}
                    </span>
                </p>
                <p><strong>Rol:</strong> 
                    <span class="badge bg-${userRoleBadge}">
                        ${userRoleText}
                    </span>
                </p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Boshqaruv</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/users/${user._id}/toggle-status" class="mb-3">
                    <button type="submit" class="btn btn-${toggleBtnClass} btn-sm w-100">
                        <i class="fas fa-${toggleIcon} me-2"></i>
                        ${toggleText}
                    </button>
                </form>

                <button type="button" class="btn btn-info btn-sm w-100" data-bs-toggle="modal" data-bs-target="#notifyModal" ${notifyDisabled}>
                    <i class="fas fa-bell me-2"></i>Xabar yuborish
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5>Buyurtma tarixi</h5>
            </div>
            <div class="card-body">
                ${ordersTableHtml}
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Xabar yuborish</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/users/${user._id}/notify">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="message" class="form-label"><strong>Xabar matni:</strong></label>
                        <textarea class="form-control" id="message" name="message" rows="4" required>Hurmatli mijoz! </textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Bekor qilish
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Yuborish
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
`, title }) %>
