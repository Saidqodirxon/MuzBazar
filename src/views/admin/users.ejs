<%
var layout = '../layouts/layout.ejs';
function fmt(n) {
    var s = String(n || 0);
    var parts = [];
    var len = s.length;
    for (var i = len; i > 0; i -= 3) {
        var start = Math.max(0, i - 3);
        parts.unshift(s.substring(start, i));
    }
    return parts.join(' ');
}

var usersHtml = '';
if (users.length === 0) {
    usersHtml = '<div class="text-center py-5"><i class="fas fa-users fa-5x text-muted mb-3"></i><h3 class="text-muted">Hali foydalanuvchilar yo\'q</h3></div>';
} else {
    usersHtml = '<div class="card"><div class="card-body"><div class="table-responsive">' +
        '<table class="table table-hover"><thead class="table-light"><tr>' +
        '<th>Ism</th><th>Telefon</th><th>Buyurtmalar</th>' +
        '<th>Summa</th><th>Tulangan</th><th>Qoldiq</th>' +
        '<th>Status</th><th>Sana</th><th>Amallar</th>' +
        '</tr></thead><tbody>';

    for (var i = 0; i < users.length; i++) {
        var u = users[i];
        var statusBadge = u.isActive ? 'success' : 'danger';
        var statusText = u.isActive ? 'Aktiv' : 'Bloklangan';
        var toggleIcon = u.isActive ? 'ban' : 'check';
        var toggleTitle = u.isActive ? 'Bloklash' : 'Aktivlashtirish';
        var notifyDisabled = u.telegramId ? '' : 'disabled';
        var blockToggleIcon = u.isBlocked ? 'unlock' : 'lock';
        var blockToggleClass = u.isBlocked ? 'success' : 'warning';

        var nameCell = '<strong>' + (u.firstName || '') + ' ' + (u.lastName || '') + '</strong>';
        if (u.username) nameCell += '<br><small class="text-muted">@' + u.username + '</small>';

        var phoneCell = u.phone ? '<a href="tel:' + u.phone + '">' + u.phone + '</a>' : '<span class="text-muted">-</span>';

        var statusCell = '<span class="badge bg-' + statusBadge + '">' + statusText + '</span>';
        if (u.isBlocked) statusCell += '<br><span class="badge bg-danger mt-1">Blok</span>';

        var debtClass = (u.totalDebt || 0) > 0 ? 'text-danger fw-bold' : 'text-success';

        var actionsCell = '<div class="btn-group" role="group">' +
            '<a href="/admin/users/' + u._id + '" class="btn btn-sm btn-outline-primary" title="Korish"><i class="fas fa-eye"></i></a>';

        if (u.isBlocked) {
            actionsCell += '<form method="POST" action="/admin/users/' + u._id + '/toggle-block" style="display:inline">' +
                '<button type="submit" class="btn btn-sm btn-outline-' + blockToggleClass + '"><i class="fas fa-' + blockToggleIcon + '"></i></button></form>';
        }

        actionsCell += '<form method="POST" action="/admin/users/' + u._id + '/toggle-status" style="display:inline">' +
            '<button type="submit" class="btn btn-sm btn-outline-' + (u.isActive ? 'warning' : 'success') + '"><i class="fas fa-' + toggleIcon + '"></i></button></form>';

        actionsCell += '<button type="button" class="btn btn-sm btn-outline-info" ' +
            notifyDisabled + ' data-bs-toggle="modal" data-bs-target="#notifyModal' + u._id + '"><i class="fas fa-bell"></i></button>';

        if (u.role !== 'admin') {
            actionsCell += '<form method="POST" action="/admin/users/' + u._id + '/delete" style="display:inline" onsubmit="return confirm(this.dataset.msg)" data-msg="Ochirishni tasdiqlaysizmi?">' +
                '<button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></form>';
        }

        actionsCell += '</div>';

        usersHtml += '<tr>' +
            '<td>' + nameCell + '</td>' +
            '<td>' + phoneCell + '</td>' +
            '<td>' + (u.orderCount || 0) + '</td>' +
            '<td>' + fmt(u.totalSpent) + '</td>' +
            '<td>' + fmt(u.totalPaid) + '</td>' +
            '<td><span class="' + debtClass + '">' + fmt(u.totalDebt) + '</span></td>' +
            '<td>' + statusCell + '</td>' +
            '<td>' + moment(u.createdAt).utcOffset(5).format('DD/MM/YYYY') + '</td>' +
            '<td>' + actionsCell + '</td></tr>';
    }

    usersHtml += '</tbody></table></div></div></div>';

    // Notification modals
    for (var j = 0; j < users.length; j++) {
        var mu = users[j];
        usersHtml += '<div class="modal fade" id="notifyModal' + mu._id + '" tabindex="-1">' +
            '<div class="modal-dialog"><div class="modal-content">' +
            '<div class="modal-header"><h5 class="modal-title">Xabar yuborish: ' + (mu.firstName || '') + '</h5>' +
            '<button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
            '<form method="POST" action="/admin/users/' + mu._id + '/notify">' +
            '<div class="modal-body"><div class="mb-3">' +
            '<label class="form-label">Xabar matni:</label>' +
            '<textarea class="form-control" name="message" rows="4" required>Hurmatli ' + (mu.firstName || '') + '!</textarea>' +
            '</div></div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>' +
            '<button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-1"></i>Yuborish</button>' +
            '</div></form></div></div></div>';
    }
}

var searchVal = typeof search !== 'undefined' ? search : '';
var body = '<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">' +
    '<h1 class="h2"><i class="fas fa-users me-2"></i>Foydalanuvchilar</h1></div>' +
    '<div class="row mb-3"><div class="col-md-6">' +
    '<form action="/admin/users" method="GET" class="d-flex">' +
    '<input type="text" name="search" class="form-control me-2" placeholder="Qidiruv..." value="' + searchVal + '">' +
    '<button class="btn btn-outline-secondary" type="submit">Qidirish</button>' +
    (searchVal ? '<a href="/admin/users" class="btn btn-outline-danger ms-2"><i class="fas fa-times"></i></a>' : '') +
    '</form></div></div>' + usersHtml;
-%>
<%- include(layout, { body: body, title: title }) %>